## 후기 수정과 삭제
- 후기 수정 페이지와 삭제 페이지 구현

- **views 디렉터리 내부 reviews.py에서 코드 추가하기**

```python
from django.views.generic import CreateView, UpdateView, DeleteView
...

# 리뷰 수정하기
class ReviewUpdateView(UpdateView):
    model = Review
    pk_url_kwarg = 'review_id'
    fields = ['comment', 'ratings'] 
    template_name = 'review/update.html'
    success_url = reverse_lazy('review-history')
    
    
# 리뷰 삭제하기
class ReviewDeleteView(DeleteView):
    model = Review
    pk_url_kwarg = 'review_id'
    success_url = reverse_lazy('review-history')
    
    def get(self, request, *args, **kwargs):
        return self.post(request, *args, **kwargs)
```

- **먼저 UpdateView를 import 해주기. 그리고 ReviewUpdateView 클래스 정의하기.** 
- pk_url_kwarg는 path 파라미터로 review_id라는 변수를 받을 수 있도록 설정한다. 그리고 comment와 ratings 2개의 필드를 수정할 수 있게 한다. 
- 또한 url은 review-history라고 새로 만들 예정. 그래서 업데이트를 하면 내가 쓴 후기목록으로 돌아가게 된다. 

- **그리고 그 밑에는 리뷰 삭제 클래스를 생성해준다. 수정하기와 비슷하게 설정.**
  - **다만 ReviewDeleteView는 GET으로 접근했을 때도 --> POST로 접근한 것 처럼 만들어줄 수 있다. 이렇게하면 ReviewDeleteView에 GET으로 접근해도 POST가 실행이 된다. 그러면 바로 삭제 기능이
    구현된다.** 
    

- **views 디렉터리 내부 history.py에서 코드 추가하기**

```python
from ..models import Booking, PayHistory, Review
...

# 리뷰 목록 리스트 보여주기
class ReviewHistoryView(ListView):
    model = Review
    template_name = 'review/reviews.html'
    paginate_by = 5

    def get_queryset(self):
        return Review.objects.filter(user=self.request.user).all()
    
    
```

- **Review를 Import하고 ReviewHistoryView를 정의한다. 페이지네이션은 한 페이지에 5개 데이터를 설정.**
- **그리고 get_queryset 메소드를 설정해서 GET방식일 때 template에 넘겨 줄 데이터를 코드로 추가한다.** 로그인된 사용자의 review 데이터를 넘겨준다. 

- **또한, 이 리뷰 내역 리스트와 리뷰 작성 기능도 로그인된 사용자만 사용할 수 있도록 해야한다.** 그래서 reviews.py에 있는 ReviewCreateView와 ReviewUpdateView, ReviewDeleteView에다가

```python
from django.contrib.auth.mixins import LoginRequiredMixin
...

class ReviewCreateView(LoginRequiredMixin, CreateView):
    ...
    
    
# 리뷰 수정하기
class ReviewUpdateView(LoginRequiredMixin, UpdateView):
    model = Review
    pk_url_kwarg = 'review_id'
    fields = ['comment', 'ratings'] 
    template_name = 'review/update.html'
    success_url = reverse_lazy('review-history')

    def form_valid(self, form):
        review = self.get_object()
        if review.user != self.request.user:
            raise PermissionDenied()
        return super().form_valid(form)
    
    
# 리뷰 삭제하기
class ReviewDeleteView(LoginRequiredMixin, DeleteView):
    model = Review
    pk_url_kwarg = 'review_id'
    success_url = reverse_lazy('review-history')

    def get(self, request, *args, **kwargs):
        return self.post(request, *args, **kwargs)

    def post(self, request, *args, **kwargs):
        review = super().get_object()
        if self.request.user != review.user:
            raise PermissionDenied()
        return super().post(self, request, args, kwargs)
```

- **LoginRequiredMixin를 추가로 상속하게 한다. 그래서 LoginRequiredMixin를 import 해주기.**
- ReviewDeleteView의 경우에는 post 방식을 덮어쓰기 하고, review를 super()로 get_object()를 받아와서, 만약 로그인한 유저와 review의 유저가 다를경우 에러를 발생시키도록 한다. 
  - 만약 같다면 super()로 부모의 post를 불러온다..

- **ReviewUpdateView에도 코드를 추가해준다.**
  - form_valid를 덮어쓴다. 그래서 review값을 가져오고 이번에도 로그인한 유저와 review의 유저가 다를경우 에러를 발생시키도록 한다. **get_object()** 를 command로 보면, queryset이 
    정의되지 않으면, 그냥 object가 떨어지는 형태이다. 그래서 위의 코드에서는 현재 우리가 수정하는 대상이 나오게 된다. 


- **그 다음, 다시 history.py에서도 동일하게 적용**

```python
class BookingHistoryView(LoginRequiredMixin, ListView):
        ...


class BookingCancelView(View):
    def get(self, request, booking_id):
        booking = get_object_or_404(Booking, pk=booking_id)

        if booking.user != self.request.user:
            raise PermissionDenied()

        if booking.status != Booking.PayStatus.PAID:
            messages.warning(request, '취소할 수 없는 예약입니다.')
            return redirect('history')
        
        response = requests.post('https://api.tosspayments.com/v1/payments/'
                                 + booking.pg_transaction_number + '/cancel',
                                 json={'cancelReason': '고객 예약취소'},
                                 headers = {
                                     'Authorization': 'Basic dGVzdF9za196WExrS0V5cE5BcldtbzUwblgzbG1lYXhZRzVSOg==',
                                     'Content-Type': 'application/json',
                                 })
        
        if response.ok:
            with transaction.atomic():
                booking.status = Booking.PayStatus.CANCELED
                booking.canceled_at = timezone.now()
                booking.seat.remain += 1
                booking.save()
                booking.seat.save()
                PayHistory.objects.create(booking=booking, amount=-booking.price)
                
        return redirect('history')



# 리뷰 목록 리스트 보여주기
class ReviewHistoryView(LoginRequiredMixin, ListView):
        ...
        
```

- LoginRequiredMixin를 적용해준다. 
- BookingCancelView에는 if booking.user != self.request.user: 이렇게 유저가 다를 떄 raise PermissionDenied() 해당 에러를 발생시켜준다.


- **그리고, urls.py를 설정**

```python
from web.views.history import BookingHistoryView, BookingCancelView, ReviewHistoryView
from web.views.reviews import ReviewCreateView, ReviewUpdateView, ReviewDeleteView
...

urlpatterns = [
    ...
    # 예약 후기 생성 페이지 URL
    path('review/booking/<int:booking_id>/', ReviewCreateView.as_view(), name='review-create'),

    # 후기 수정 페이지 URL
    path('review/<int:booking_id>/update/', ReviewUpdateView.as_view(), name='review-update'),
    
    # 후기 삭제 페이지 URL
    path('review/<int:booking_id>/delete/', ReviewDeleteView.as_view(), name='review-delete'),
    
    # 후기 리스트 URL
    path('review/', ReviewHistoryView.as_view(), name='review-history'),
] + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)

```

- **이렇게 ReviewHistoryView를 가져와주고, ReviewCreateView, ReviewUpdateView, ReviewDeleteView도 가져온다. 그리고 URL 경로를 설정해주기.** 

- **11분부터 Refactor라는 개념이 나온다. 알아보기. history.py를 booking.py로 수정 / templates 내부에 history 디렉터리는 booking으로 수정**
  - 14분부터는 url 수정.
  - BookingView가 아니라 RestaurantBookingView로 수정. / PayView도 RestaurantPayView로 수정.






