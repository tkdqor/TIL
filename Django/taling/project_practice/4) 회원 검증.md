## 회원 검증
- 회원가입 시 이메일 검증에 대해서 알아보자. 회원가입을 이메일 계정으로 한다면 해당 이메일이 올바른건지 검증절차를 거쳐야 한다. 검증절차는 다음과 같다.
  - 회원가입 시 이메일 계정이 입력된다. 
  - 새로운 계정을 생성할 때 고유한 문자열을 하나 생성한다. 이걸 검증 키라고 한다.
  - 입력된 이메일 주소로 이메일 검증 뷰에 쿼리 파라미터로 검증키를 포함시켜 전송한다.
  - 그리고 검증 키를 데이터베이스에 검증하려는 사용자와 함께 저장한다.
  - 사용자가 받은 이메일 내의 링크를 클릭하면 검증 뷰로 검증키가 GET 파라미터로 전달된다.
  - 마지막으로 뷰에서 검증키를 받으면 해당 키와 일치하는 정보를 데이터베이스에서 조회해서 해당 유저의 검증을 승인한다.


### SMTP 서버
- 이러한 검증 절차를 진행하려면 반드시 이메일 발송 로직이 필요한데 django에서는 SMTP 서버를 통해 메일을 보내도록 설정할 수 있다. 
  - SMTP 서버는 Simple Mail Transfer Protocol을 지원하는 서버를 의미한다. 즉, 메일을 발송할 때 사용되는 프로토콜을 지원하는 서버이다. 
  - 우리가 배운 HTTP가 웹에서 요청을 주고받는 방식을 정의하는 것처럼 메일 송수신을 처리하는 방식을 정의하는 프로토콜을 의미한다. 
  - 우리가 직접 구축하지 않더라도 몇 군데에서 SMTP 서버를 사용할 수 있도록 제공해주고 있다. 대표적으로 Gmail API, Mailgun, Amazon SES 등이 있다. 우리는 Amazon SES를 사용해서 이메일 전송 
    로직을 구현해보자. Amazon SES에서는 한 달에 6만 건 정도의 메일을 발송할 수 있는 것을 무료로 제공하고 있어 초기 테스트에는 부담없이 사용할 수 있다.



### 실습하기
- 먼저 django-ses를 설치한다.
```terminal
pip install django-ses
```

- 설치가 된 것을 확인한 다음, settings.py로 가서 맨 아래쪽에 관련 세팅값들을 넣어줘야 한다. 

```python
# Email
EMAIL_BACKEND = 'django_ses.SESBackend'
```

- **이렇게 명시해주면, 방금전에 설치한 django-ses에서 제공하는 클라이언트를 사용해서 메일을 전송하도록 django에서 지원하고 있다.**
- 이제 아마존 사이트에 들어가서 **IAM이라는 것을 클릭하자. 이건 아마존 서비스에 접속할 수 있는 계정을 만들 수 있는 콘솔이다.** 우리는 여기서 django가 아마존의 메일 서비스인 SES로 접속할 수 있는
  계정을 만들 것이다.
  - 옆에 **사용자**라고 되어있는 부분을 클릭하자. 그리고 **사용자 추가**를 누른다. 그리고 **사용자 이름**에다가는 django-ses-user라고 입력을 해준다. 그 다음 밑에 액세스 유형은 **엑세스 키 - 프로그래밍 방식 액세스** 를 선택해준다.
  - 우리는 지금 프로그래밍 코드를 통해서 로그인을해서 이메일을 전송할 것이기 때문에 해당 부분을 선택해주는 것이다.
  - 그 다음으로 넘어가면 **권한 설정** 부분이 나온다. 이 IAM은 SES만 이야기하는 건 아니고 우리가 이 계정을 통해 할 수 있는 거의 모든 권한을 다 부여할 수 있다. 그래서 지금 계정에 어떤 접근 권한을 줄 것인지 선택해줘야 한다.
  - 그래서 지금은 **기존 정책 직접 연결**을 선택해주자. 그러면 여러가지 정책 set들이 있는데, 여기서 **AmazonSESFullAccess**라는 것을 체크해주면 된다.
    - **이 권한을 부여하면 이 계정으로 로그인할 때, 그 때 부터는 이 계정이 로그인 상황에서 SES에 있는 SMTP 서버에 접근해서 메일을 전송하는게 가능해진다.**
  - 다음을 누르면 태그 추가 화면이 나오는데 바로 다음으로 넘어가자.
  - 그러면 **검토** 부분이 나온다. 

<img width="1011" alt="image" src="https://user-images.githubusercontent.com/95380638/160738165-97fe22a6-5647-4e46-804f-1d8168bbc626.png">

- 이런식으로 설정이 잘 되었는지 확인한 다음에 **사용자 만들기** 버튼을 클릭하자. 이렇게 하면 사용자가 완성이 되는데 여기서 **csv를 다운로드** 하게 되면 엑세스 키랑 비밀 엑세스 키가 다운로드가 된다.
  - 이 파일을 잘 보관해야 한다. 나중에 우리가 사용해야 하기 때문이다. **비밀 엑세스 키**는 패스워드와 같은 역할을 하기 때문에 이게 외부에 노출되지 않도록 해야한다. 지금 화면에서 csv를 다운받지 않으면 
    다시 확인 할 방법이 없다. 그래서 계정 생성 시 csv를 다운받아서 보관해야 한다. 
  - 해당 화면에서 **엑세스 키 ID**를 복사한 다음, settings.py로 가서 코드를 추가하자.

```python
# Email
EMAIL_BACKEND = 'django_ses.SESBackend' 
AWS_ACCESS_KEY_ID = '엑세스 키 ID 넣어주기'
AWS_SECRET_ACCESS_KEY = '비밀 엑세스 키 넣어주기'
AWS_SES_REGION_NAME = 'ap-northeast-2'
AWS_SES_REGION_ENDPOINT = 'email.ap-northeast-2.amazonaws.com'
```
- 이렇게 각각 항목을 복사해서 넣어주면 된다. 그 다음에는 region를 정해줘야 하는데, **ap는 asia pacific를 의미한다. 그리고 'ap-northeast-2'를 입력하면 서울을 의미하게 된다.(동북아시아2)**
- 그리고나서 **region endpoint**를 입력한다. 이걸 입력하는 것은 현재 동북아시아권 엔드포인트, 즉 접속할 주소가 이것이라는 것을 알려주는 것이다.


* * *
- **이제 다시 aws에서 SES라고 검색한 다음 들어가보자. SES에서는 정식으로 도메인을 인증하기 전까지 스팸메일로 발송하는 것을 막기 위해서 개발자 이메일, 인증된 메일로만 송수신을 할 수 있다. 그래서 메일을
  발송하기 전에 일단은 우리가 테스트로 수행할 이메일 인증을 해주어야 한다.** 
  - SES Home에서 Email Addresses를 클릭 --> 이제는 화면이 바껴서 SES에서 왼쪽 메뉴 중 Verified identities 클릭
  - 그래서 이메일로 인증을 선택하고 내 이메일을 입력하면 -> 내 이메일로 메일이 하나가 온다. 그 링크를 클릭해주면 Verification Status가 verified로 바뀌면서 
<img width="1359" alt="image" src="https://user-images.githubusercontent.com/95380638/160743603-1886c3e1-c59f-46a0-9dd3-19f4ab8d90b4.png">

- 이렇게 표시가 된다. 그래서 이 메일로 송신과 수신을 할 수 있게 된다. 송신의 경우에도 서버는 AWS에 있는 것을 사용해서 여기서 발송이 되지만, 발송자에 뜨는 이메일을 보면 수신하는 입장에서 봤을 때,
  발송자가 누군지 어떤 이메일인지 표시가 될 것 이다. 그래서 항상 여기서 발송할 때는 발송자의 이메일이 실제 인증된 이메일이어야지만 발송이 된다.
  
  
  
