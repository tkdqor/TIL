## 소셜 로그인
- 구글과 카카오를 이용하여 소셜 로그인 기능 구현하기


### 소셜 로그인의 구조
- 3개의 주체 : django 백엔드 서버 / 사용자의 웹 브라우저(클라이언트) / 인증 제공자 서버(SNS) (사용자의 로그인 계정을 저장하고 있을 SNS 서버)
- Oauth 2.0 표준으로 주로 구현되고 사용된다.


### 소셜 로그인 구현 과정(바탕화면 캡처 참고)
- 사용자는 먼저 우리의 웹서비스의 로그인 페이지에 접근한다. 그래서 거기에서 구글로 로그인이나 카카오로 로그인하기를 클릭하는 것이다. 
- 그 다음 이제 사용자가 아이디와 비밀번호를 입력하고 로그인 버튼을 클릭하면 이 때 부터 소셜네트워크 서버의 역할이 개입된다. 보통은 해당 SNS의 로그인 폼이 열리거나, SNS에 이미 로그인이 되어있다면 확인 버튼 정도만 표시되고 권한을
  허락할지 말지 정도만 뜰 것이다. 그래서 그 버튼을 누르면 다음으로 넘어가는 것을 우리가 흔히 볼 수 있다. 
  - 이 때, 브라우저는 이 페이지를 오픈하기 위해서 URL을 브라우징할 때, SNS 서버로 어떤 외부 서비스로 로그인을 시도하는지 값을 보내게 되는데 이 값을 **클라이언트 ID**라고 한다.
  - **그래서 로그인 페이지에는 html이나 자바스크립트 코드내에 인증서버로 어떤 요청을 보내야 되는지를 구현하는 코드가 들어가있게 된다.**
- 그래서 인증서버로 로그인 요청을 보낼 때, 백엔드 서버에서는 ex) table_bookings에 대한 대표값을 하나 보내게 되고 그게 바로 **클라이언트 ID**인 것이다.
  - 인증서버로 요청 시, 추가로 나중에 이 인증이 성공되고나서 백엔드 서버에서 어떤 주소로 되돌아올 것인지 정의하는 **Redirect 또는 Redirection URI**라는 것을 같이 보내게 된다.
- 이제 로그인이 성공하면 **SNS 서비스는 고유한 승인코드를 하나 생성**해서 보내주게 되는데, **이 때 웹브라우저 단에서 Redirection URI로 페이지 이동이 이루어질 때 이 코드가 같이 쿼리 파라미터로 전송된다.**
- 그래서 우리 서버에서 이 코드를 받고 다시 한 번 SNS 서버에 정상적인 코드인지를 물어보고 그게 성공하면(승인코드인 Authorization Code를 받으면) **접근토큰(Access Token)이라는 로그인된 계정의 접속 키 역할을 하는 값을 받게 된다.**
  - 즉, 다시말해 우리 서버에서 Authorization Code를 받아서 -> SNS 서버에 승인 확인 요청을 보내고 -> Access Token를 돌려받으면, 이제 그 Access Token으로 해당 사용자에 이메일이나 이름 혹은 권한 허가 범위에 따라서 나이나 성별 등의 정보를 얻어올 수 있게 된다.
- **우리는 이렇게해서 다른 SNS 계정의 정보를 우리쪽에 로그인과 회원가입을 처리할 수 있게 되는 것이다.**

- **이러한 인증 Flow는 SNS가 생겨나고 여러해동안 보안이 강화되고 여러단계들이 표준화되면서 하나의 공통 표준으로 자리잡게 되었는데, 이러한 표준을 OAuth 2.0이라는 스펙으로 정의하고 있다.**
  - 그래서 이번 강의도 이 OAuth 2.0를 사용하여 구글이나 카카오에 로그인을 해보는 것이다.
  - 실제로 OAuth 2.0 스펙에 맞춰서 제대로 구현하려면, 표준 내에 있는 여러 조건들을 다 만족시켜야 하지만, 이를 대신해서 라이브러리로 제공해주는 게 있다. 


### django-all-auth 라이브러리
- 그게 바로 django-all-auth 라이브러리이다. 먼저 table_bookings 디렉터리에서 

```terminal
pip install django-allauth
```

- 이 명령어를 통해 설치를 한다. Successfully installed가 뜨면 설치가 된 것이다. 그 다음에 settings.py로 가서 

```python
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'django.contrib.sites',
    'web',

    # all auth
    'allauth',
    'allauth.account',
    'allauth.socialaccount',
    'allauth.socialaccount.providers.auth0',
    'allauth.socialaccount.providers.google',
    'allauth.socialaccount.providers.kakao',
]
```

- **contrib에 있는 sites를 등록해줘야 한다. 그래야 우리가 sites 설정을 어드민에서 불러와가지고 카카오나 구글에 인증정보들을 넣을 수 있게 된다.**
- 그리고 all auth 모듈 관련해서는, allauth와 allauth.account를 가져와서 allauth에서 사용하는 계정 set들과 관련된 기능들을 가지고 올 수 있게 된다. 
- 추가로 'allauth.socialaccount' 을 가지고오면 allauth로 SNS 계정 연동이 가능하게 해주는 모듈이다.
  - 그 모듈안에 providers 다음에 auth0 / google / kakao 이렇게 우리가 연동하기를 원하는 provider를 각각 가지고 오는 것이다. auth0는 디폴트라고 보면 되고 google과 kakao를 연동하기 위해 가지고 온 것이다.

- settings.py 맨 아래쪽에는, 

```python
...
# All auth
LOGIN_REDIRECT_URL = ''
ACCOUNT_LOGOUT_REDIRECT_URL = ''
ACCOUNT_LOGOUT_ON_GET = True
```

- 이렇게 All auth라고 구분해주고, **LOGIN_REDIRECT_URL** 변수를 만들어서 로그인이 성공할 경우에는 첫 페이지로 돌아가겠다고 설정해주자.
- 그리고 **ACCOUNT_LOGOUT_REDIRECT_URL**라는 변수를 만들어서 로그아웃 후에도 첫 페이지로 가겠다고 정의해준다.
- 또 **ACCOUNT_LOGOUT_ON_GET = True** 이렇게 True로 설정하면 -> 로그아웃을 할 때, URL로 GET으로 접근해도 로그아웃 처리를 할 수 있도록 열어주는 것이다. 

* * *
- 그 다음은 urls.py 설정이다. 7:40





