## 트랜잭션과 락


### 결제 수행 과정
1. 고객이 원하는 일자와 시간을 선택
2. 예약정보입력 페이지로 이동 후 예약자명, 전달사항을 적는 폼 페이지에서 관련 정보를 입력
3. 예약 보증금 결제 처리 -> 이 때 결제처리과정을 거치게 됨
   - **a) PG사에 결제 요청** / PG사는 Pay Gateway의 약자로 여러가지 결제 인증 업체들이 있다. 우리가 계죄이체할 때, 한국에 있는 20개가 되는 은행들과 연동을 해야 계좌이체가 발생한다. 카드결제 시, 카드사 같은 경우도 
     10개가 넘어간다. 이렇게 많은 결제 업체들, 즉 결제 수단을 제공하는 그런 회사들이 있다. 이 회사들에 있는 정보랑 통신들을 전부 다 매핑을 해서 우리가 이커머스 사이트를 운영할 때 결제 모듈을 불러와서 
     쓸 수 있게 해주는 게 바로 PG사의 역할이다. 따라서 PG사의 경우에는, 우리가 그냥 PG사에 연동만 해놓으면 그러한 다양한 결제 수단 업체들에 대한 요청을 보낼수가 있고, 인증도 걸쳐서 결제를 진행할 수
     있게 되는 것이다. 그래서 이 a 단계는 결제창을 여는것부터 시작한다. 그래서 우리가 상품을 구매할 때 --> 결제 화면이 열리면서 거기서 카드를 선택하거나 은행을 선택하거나 했을 것이다. 그렇듯이 그렇게
     창을 여는 단계라고 생각하면 된다. 
   - **b) 다음으로는 카드 결제의 경우 카드 인증 단계가 있다. 또한, 계좌이체의 경우 공인인증서를 인증하는 단계가 있을 수 있다. 휴대폰 결제는 휴대폰 인증이 있고 상품권 결제는 상품권 인증이 있다.** 
     가상계좌의 경우에만, 한번에 끝나기 때문에 가상계좌는 별도의 인증 단계를 거치지 않는다. 보통 이러한 인증수단들은, 예를 들어 카드 결제를 할 경우에는 현대카드이면 현대카드, 삼성카드면 삼성카드, 
     롯데카드면 롯데카드, 이런식으로 해당 카드 업체에 서버를 통해서 인증이 이루어지게 된다. 
   - **c) 다음으로는 데이터베이스에 예약 내역을 입력하는 단계이다. 해당 DB는 우리쪽 DB를 의미한다.** 인증된 값을 우리의 웹 서비스에서 실제로 결제할 금액과 매핑을 해서 검사를 한 뒤에, 이 데이터가 
     유효하게 완성이 되어있으면,
   - **d) 최종적으로 결제 승인 요청을 PG사한테 보내면, 그 PG사가 위에서 인증한 카드사나 은행들한테 인출을 해달라고 연락을 하는 단계가 된다.** 
   - **정리해보면 a 단계는 결제에 필요한 값들을 입력받는 단계 / b 단계는 결제 수단에 대해서 내가 실제로 소유자인지 아닌지를 인증하는 인증단계 / c 단계는 우리쪽에서 데이터베이스에 데이터를 입력하는 단계 / d 단계는 모든 조건이 만족하고 유효성이 검증되면 마지막으로 우리 서버에서 PG사한테 연락을 해서 결제를 해줘 라고 연락하는 단계이다. 그러면 PG사가 알아서 결제를 처리하게 된다.**
     - 여기서 말하는 c와 d단계는 순서가 바뀌어도 무방한 단계이다.  


### 결제 수행 과정 시, 문제 발생
- **유저 여러 명이 하나의 남은 좌석을 가지고 결제하는 경우, 먼저 결제가 끝난 유저 외의 다른 유저는 위의 단계를 동시에 거치고 있다면 d 단계까지 왔을 때, 오버 부킹이 되는 이슈가 있다.**
- 이런식으로 제한된 자원을 가지고 여러 사람들이 경쟁하는 상황을 **Race Condition**이라고도 한다. **특히 최종 결제 승인이 처리될 때, 실패하는 경우가 있을 수 있다. 이럴 경우에는 c 단계를 어떻게 돌아갈 것이냐, 즉 예약 내역 입력을 어떻게 해야하지? 이러한 생각이 들게 된다. 결제 발생이 실패를 했는데, 우리의 DB에는 예약이 된 것으로 입력이 되어있는 그런 상황이 발생할 수 있다는 것이다.**


### 개선된 예약 수행 과정
- 위의 문제들을 조금 개선해보자면,      
**1. 처음에 우리 DB에 예약 내역을 먼저 입력한다.(우리 서버)** 그래서 우리 서버에 먼저 기록을 해둔다.     
**2. 고객이 그 다음에 결제창을 띄워서 PG 결제를 요청한다.(PG사 서버)**      
**3. 카드 결제의 경우, 카드 인증을 하고 다른 수단도 인증을 거친다.(카드사 또는 은행 서버 등등)**      
**4. 최종 결제 승인을 거치고(실 결제 발생)(우리 서버)**     
**5. 승인이 끝나고 나면 우리 서버 DB에 있는 예약 내역을 성공으로 업데이트를 하는 것이다.**      
- 여기서 2번과 3번은 우리 서버에서 일어나는 이벤트가 아니다. 그러다보니까 이 2번과 3번을 거치기 전에 우리쪽에 먼저 1번으로 누군가가 찜해놓았다 라는 표식을 남겨둬야 다른 사람이 여기서 들어올 때 이걸 보고 아직 내가 들어올 차례가 아니구나 라고 대기를 탈 수 있게 된다. 
- **그 다음 4,5번에서 마무리를 짓는 것이다. 그런데 이러한 수행 과정도 사실 중간에 하나라도 실패한다면, 전체가 실패 해야하는 그런 조건을 가지고 있다. 이렇게 수행되는 시간이 다르지만, 한 번에 묶음처리 되어야 하는 것을 트랜잭션이라고 부르게 된다.** 
  - 여기서 말하는 결제 요청과 카드 인증은 사용자 입력이 필요하고 그리고 우리 서버에서 일시적으로 이루어질수는 없기 때문에 코드상으로는 하나의 트랜잭션 구현이 불가능하지만, 이렇게 앞에 1번 단계를 둠으로서 비슷한 효과를 줄 수 있게 되는 것이다.
  - 그래서 1번에서 데이터를 선점 입력하는 것에 실패한다면, 결제를 진행하지 않게 된다. 하지만, 코드상에 트랜잭션으로 실제 구현하려면 하나의 메소드내에 연달아 로직이 수행되어야 하므로 **코드 상 트랜잭션은 1번 그리고 4,5번이 된다.** 2,3번은 각각 우리 사이트에서 벗어나서 다른 사이트로 이동하는 과정이므로 우리가 트랜잭션을 유지할 수는 없어서 1번에서 선점하는 식으로 보완을 하는 것이다. 


### 트랜잭션의 정의



