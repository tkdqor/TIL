## 배포
- 배포를 위해 github를 활용할 예정이다. 만약 레포지토리가 private이면 ubuntu 서버에서 소스 코드를 바로 내려받을 수 없다. 그래서 내려받을 수 있도록 접근 키를 받아야 한다. 
- ssh-keygen이라는 키 생성 프로그램을 써서 RSA라는 알고리즘을 사용하는 암호화 키를 하나 생성할 것이고 cat 명령으로 화면에 출력할 것이다. 
- 터미널로 가서 ubuntu 서버로 접속해 있는 상태에서

```terminal
ubuntu@ip-172-31-22-117:~$ ssh-keygen -t rsa
```

- **이렇게 입력해주기. 그러면 이 암호화 알고리즘을 써서 키를 만드는데 그 다음에 나오는 코드에서는 모두 엔터 3번을 해주면 된다.** 


```terminal
ubuntu@ip-172-31-22-117:~$ cat /home/ubuntu/.ssh/id_rsa.pub
```

- **그 다음에는 이렇게 입력해주기. 위에서 키를 만드면 코드로 Your Public key has been saved in 하면서 공개키가 어디에 저장되었다고 나온다. 그래서 그 경로로 들어가 파일 내용을 보는 것이다.** 
- 이렇게 입력해주면 어떤 문자열이 뜨게 된다. 이 부분이 바로 우리가 Github에 우리가 올려둬야 할 키 그 자체가 된다. 
  - **그러니까 github이라는 클라이언트를 통해서 -> Github이라는 레포지토리에 접근할 때 ssh를 통해서 접근하게 되는데, 그럴 때마다 이 ssh 클라이언트가 여기에 있는 키, 우리가 만든 public 키를 실어서 보낼 수가 있다.** 
  - **그 때 Github 사이트에 이 키를 가진 클라이언트는 허용하도록 등록을 미리 해두면 이 레파지토리에 쉽게 접근할 수 있게 된다.**


### Github 레포지토리로 가기
- 배포하려고 하는 레포지토리 화면에 가서 settings라는 메뉴가 있는데, 여기로 들어가서 왼쪽에 보면 **Deploy keys**라는 게 있다.
- 여기로 들어가서 **Add deploy key를 눌러주고 위에서 나온 문자열들을 복사해서 Key 부분에 붙여넣기를 해준다.** 그리고 title에는 ubuntu deploy key라고 한다. 그리고 add key를 누른다. 이렇게 하면 등록이 된다.

- **이제 우리의 ubuntu 서버에서 이 레포로 접근할 수 있는 길이 생긴 것이다.** 이제 다음 명령어들을 차례대로 수행해서 /home/ubuntu 아래에 www라는 폴더를 만들고 

```terminal
ubuntu@ip-172-31-22-117:~$ mkdir www
ubuntu@ip-172-31-22-117:~$ cd www

ubuntu@ip-172-31-22-117:~/www$
```

- **이 안에 들어가서 클론을 해보자.**



```terminal
ubuntu@ip-172-31-22-117:~/www$ git clone SSH 레포지토리 주소
```

- **여기서 git clone 다음에 github 주소를 입력할 때, 주소는 우리가 원격 저장소를 등록할 때 썼던 https 주소가 아니라, ssh 주소를 입력해줘야 한다.**
  - **그래서 레포지토리 화면에서 Code 버튼을 클릭하고 -> SSH를 클릭하고나서 주소를 복사한 다음에 붙여넣기를 해준다.**
  - 중간에 뭔가가 떠도 yes 눌러주기. 

- 그러면 이제 ls로 입력하면 레포지토리 이름으로 된 폴더가 잘 뜨게 된다.

```terminal
ubuntu@ip-172-31-22-117:~/www$ ls
tc-django-chapter-3
```

- 이제 해당 프로젝트 폴더로 이동해준다.


```terminal
ubuntu@ip-172-31-22-117:~/www$ cd tc-django-chapter-3/

ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3$ ls
requirements.txt voteapp
```

- **이 때, tc-django-chapter-3라는 프로젝트 폴더 안에 requirements.txt 파일을 꼭 참고해서 github에 미리 올려두고 지금 과정을 진행해야 한다. (강의 자료를 참고해보자)**


### ubuntu git clone 이후 해당 프로젝트 폴더에서 진행
- 이제 해당 프로젝트 폴더에 들어온 상태에서 --> 차례대로 virtualenv를 생성하고 pip로 패키지를 설치하기.

```terminal
ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3$ sudo apt-get install virtualenv
```

- **이렇게 virtualenv를 설치해준다.**


```terminal
ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3$ virtualenv -p python3 venv
ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3$ ls
requirements.txt venv voteapp
```

- **그 다음은 이렇게 입력해서 폴더를 만들어준다.(venv라는 이름의 가상환경을 만들어준다.)**


```terminal
ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3$ source venv/bin/activate

(venv) ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3$
```

- **그리고 이렇게 activate를 해준다.**


```terminal
(venv) ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3$ pip install -r requirements
```

- **그리고나서 requirements.txt에 있는 내용들을 바탕으로 필요한 패키지들을 전부 설치한다.** 


- **설치가 다 되었으면, 이제 django 웹 앱을 실행시켜볼 것이다. 외부에서도 접속이 가능하게 하려면 runserver만 하면 안되고 뒤에 0.0.0.0:8000을 정확하게 입력해야 -> 외부 접속이 가능한 형태가 된다.**


```terminal
(venv) ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3$ cd voteapp/

(venv) ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3/voteapp$ python manage.py runserver 0.0.0.0:8000
```

- 해당 프로젝트 폴더로 들어가서 python manage.py runserver 0.0.0.0:8000 이렇게 입력해준다. --> **이렇게 실행시켜주는 것이 외부에 다른 IP에서도 8000번 포트로 접속하면 들어올 수 있게 하는 걸까..?**

- **그리고나서 우리가 AWS EC2에서 생성한 인스턴스의 "퍼블릭 IPv4 주소"를 복사해준다.**
  - 그 다음 브라우저에서 **"복사한 IP주소:8000"** 이렇게 입력해보면, 뭔가 뜨긴 뜨는데 허가되지 않는 호스트라고 뜨게 된다. 
  - 기본적으로 로컬에서 접속하는 게 아니면 django에서 일단 디폴트로 설정해놓은 것이다. 
  - settings.py에서 allowed host에 다음의 코드를 추가하면 오픈되도록 할 수 있다. 우리가 배웠던 vi를 써서 고쳐보자.



```terminal
(venv) ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3/voteapp$ cd voteapp/
(venv) ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3/voteapp/voteapp$

(venv) ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3/voteapp/voteapp$ ls
... settings.py ...
```

- **이렇게 내부에 settings.py가 있는 위치로 들어가준다. 그래서 이걸 vi로 연다.**


```terminal
(venv) ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3/voteapp/voteapp$ vi settings.py
```

- **그러면 내부에 ALLOWED_HOSTS = [] 이러한 코드가 있는데, 이게 바로 django 어플리케이션에서 서버가 뜰 때 허가해 줄 호스트를 지정하는 역할을 한다.** 여기에 우리의 IP를 써도 되지만, 

```python
ALLOWED_HOSTS = ['*']
```

- **이렇게 *를 입력해주면 모든 곳에서 열리게 된다. 그 다음에 :w로 저장하고 :q로 나가주면 된다.**


- 그 다음에 다시 

```terminal
(venv) ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3/voteapp$
(venv) ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3/voteapp$ ls
... manage.py ...

(venv) ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3/voteapp$ python manage.py migrate

(venv) ubuntu@ip-172-31-22-117:~/www/tc-django-chapter-3/voteapp$ python manage.py runserver 0.0.0.0:8000
```

- **이렇게 manage.py 위치에서 migrate를 해준다. 이렇게해서 DB가 이 안에서도 생성되게 한다. 그리고 다시 모든 IP에서 8000번 포트로 들어올 수 있도록 서버를 구동시킨다.**
  - 그러면 이제 브라우저에서 **"복사한 IP주소:8000"** 이라고 입력했을 때 정상적으로 우리의 프로젝트가 뜨게 된다.

- **이제, 지금까지 웹 브라우저에서 잘 접속할 수 있게는 되었는데, 하지만 runserver로 실행하는 건 python 프로그램 하나가 딱 하나만 떠 있는 형태여서, WSGI를 통해 웹 서버가 요청을 받아서 넘기게 해야 동시에 여러 요청을 원활하게 처리할 수 있다.**


### Nginx와 WSGI
- 그래서 대표적인 웹 서버인 Nginx와 WSGI를 통해 배포를 마무리해보자.



