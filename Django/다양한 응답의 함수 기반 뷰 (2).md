## 다양한 타입의 HttpResponse


### 엑셀 파일 다운로드 응답
```python
from django.http import HttpResponse
from urllib.parse import quote

def response_excel(request):
    filepath = '/other/path/excel.xls'
    filename = os.path.basename(filepath)
    
    with open(filepath,	'rb') as f:
        response = HttpResponse(f, content_type='application/vnd.ms-excel')
        
        #	브라우저에 따라 다른 처리가 필요
        encoded_filename = quote(filename)
        response['Content-Disposition']	= "attachment; filename*=utf-8''{}".format(encoded_filename)
   
    return response
    
```

- 어떤 View가 있을 때, filepath처럼 엑셀 파일을 직접 읽어서, filename처럼 경로를 만들고 -> 해당 파일을 read binary 모드로 읽어서 파일 객체를 f로 획득한다. 그리고 그 객체르 HttpResponse의 첫번째 
  인자로 지정할 수 있다.
  - 굳이 f.read() 이렇게 호출해서 byte 데이터로 메모리에 올린 다음에 그 내용을 넘기지 않아도 내부적으로 읽기를 시도하기 때문에 위의 코드처럼 하면 된다. 혹은 openpyxl과 같은 라이브러리를 통해서 동적으로
    엑셀파일을 만들 수 있다.
    
- response는 엑셀파일의 내용을 참조하는 response가 된다. 
- response 관련, 만약 엑셀파일에 대해서 첨부를, 파일 다운로드 다이얼로그(화면에 보여지는 팝업형태의 창)를 브라우저에 띄워주려면 응답 헤더에 'Content-Disposition'을 지정해주면 된다. 그리고 여기에 
  attachment와 filename으로 지정해주면 다운로드가 된다. 이와 관련해서 직접 HttpResponse를 쓰기 보다는 -> django.http.FileResponse를 활용하면 좀 더 수월하게 처리할 수 있다. https://github.com/django/django/blob/3.0.2/django/http/response.py 

- Content-Disposition 헤더의 filename 매개 변수를 HTTP로 인코딩하는 방법 : https://code.i-harness.com/ko-kr/q/16d6f


### Pandas를 통한 CSV 응답 생성
- python에서 데이터 전처리, 데이터 분석을 할 때 사용하는 라이브러리.

```python
import pandas as pd
from io	import StringIO
from django.http import HttpResponse


def response_csv(request):
    df = pd.DataFrame([
          [100,	110, 120],
          [200,	210, 220],
          [300,	310, 320],
    ])
    
    io = StringIO()
    df.to_csv(io)
    io.seek(0)	# 끝에 있는 file	cursor를 처음으로 이동
    
    response = HttpResponse(io, content_type='text/csv')
    response['Content-Disposition'] = "attachment; filename*=utf-8''{}".format(encoded_filename)
    return response

```

- 데이터 분석을 안하고 django만 하는데 굳이 알아야 될까라고 생각할 수 있지만, 우리가 엑셀을 많이 활용하고 있고 실제 프로그램을 통해서 다양한 2차원 데이터, 엑셀의 행과 열의 2차원 데이터를 실제 로직으로 처리할
  일이 많다. 그런 부분을 Pandas에서 불러와서 Pandas의 DataFrame를 통해 처리하면 훨씬 수월하게 처리할 수 있다.
  - 또한 CSV나 엑셀 포맷이나 혹은 내가 원하는 특정 DB로 insert까지 Pandas를 통해서 수월하게 할 수 있다. DataFrame를 통해 통계 데이터같은 것을 로딩해서 적절히 변환, 처리, 필터링 등을 한 다음에 to_csv() 이렇게 csv 형식으로 전환할 수 있다.
  - 위의 코드에서 io는 메모리 기반의 파일 인터페이스이다. 이 io 객체를 HttpResponse의 첫번째 인자로 넣어주고 CSV 응답을 Pandas를 통해서 만들어줄 수가 있다.


### Pandas를 통한 엑셀 응답 생성
```python
import pandas as pd
from io	import BytesIO
from urllib.parse import quote
from django.http import HttpResponse


def response_excel(request):
    df = pd.DataFrame([
         [100, 110, 120],
         [200, 210, 220],
    ])
    
    io = BytesIO()
    df.to_excel(io)
    io.seek(0)
    
    encoded_filename = quote('pandas.xlsx')
    response = HttpResponse(io, content_type='application/vnd.ms-excel')
    response['Content-Disposition']	= "attachment; filename*=utf-8''{}".format(encoded_filename)
    return response

```

- 이번에는 아까와는 다르게, df.to_excel(io) 이렇게 to_excel를 통해서 엑셀파일을 만든 다음에 엑셀응답을 줄 수 있다.
- 이 때는 Pandas 라이브러리 말고도, Pandas가 여러 라이브러리들을 wrapping해서 지원해주는 기능들이 많다. 그래서 엑셀 파일을 생성할 때에는, xlwt라는 라이브러리를 설치해서 사용하면 좋다.
- 그리고 Pandas에서도 read_excel 명령을 통해서(pd.read_excel) 엑셀파일을 읽을 수도 있다. 그래서 유저가 엑셀파일을 업로드 했을 때, 어떤 필드값을 채워준다던지, 채워서 변경된 엑셀파일을 다운로드 할 수 있을 것이다. 유저가 업로드를 했을 때 그 값을 참고해서 어떠한 처리 결과를 응답으로 내어줄 수도 있다. 

- 웹에서는 HTTP 프로토콜만 지켜준다면, 어떠한 형식의 애플리케이션이든 손쉽게 만들 수 있고 우리는 웹이기 때문에, 또 요즘에는 웹 브라우저가 없는 디바이스는 거의 없으니까 광범위하게 다양한 애플리케이션을 사용할 수 있게 된다.


### Pillow를 통한 이미지 응답 생성 - 기본
```python
import requests
from io	import BytesIO
from PIL import Image, ImageDraw, ImageFont

ttf_path = 'C:/Windows/Fonts/malgun.ttf'	 # 윈도우의 맑은고딕 폰트 경로,	맥에서는 애플고딕 경로 '/Library/Fonts/AppleGothic.ttf'

image_url = 'http://www.flowermeaning.com/flower-pics/Calla-Lily-Meaning.jpg'

res = requests.get(image_url)	 #	서버로 HTTP GET 요청하여, 응답 획득
io = BytesIO(res.content)	 #	응답의 Raw	Body. 메모리 파일 객체 BytesIO	인스턴스 생성
io.seek(0)	 #	파일의 처음으로 커서를 이동

canvas = Image.open(io).convert('RGBA' ) # 이미지 파일을 열고, RGBA모드로 변환

font = ImageFont.truetype(ttf_path,	40)	 #	지정 경로의 TrueType	폰트,	폰트크기 40
draw = ImageDraw.Draw(canvas)	 #	canvas에 대한 ImageDraw 객체 획득

text = 'Ask	Company'
left, top =	10,	10
margin = 10
width, height =	font.getsize(text)
right =	left + width + margin
bottom = top + height +	margin

draw.rectangle((left, top, right, bottom), (255, 255, 224))
draw.text((15,15), text, font=font, fill=(20, 20, 20))

canvas.show()

```

- Pillow라는 이미지 처리 라이브러리가 있다. 위의 코드는 django 코드는 아니고 pillow 활용 코드이다. 

- ttf_path
